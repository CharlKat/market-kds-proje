<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market KDS - Stratejik YÃ¶netim Paneli V2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .kds-header { 
            background: linear-gradient(120deg, #1565C0 0%, #0D47A1 100%); 
            color: white; 
            padding: 25px 0; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .status-red { background-color: #ffebee !important; color: #b71c1c; font-weight: bold; border-left: 5px solid #b71c1c; }
        .status-green { background-color: #e8f5e9 !important; color: #1b5e20; font-weight: bold; border-left: 5px solid #1b5e20; }
        .alert-card-danger { border-left: 5px solid #d32f2f; background-color: #ffcdd2; }
        .alert-card-warning { border-left: 5px solid #f57c00; background-color: #ffe0b2; }
        .alert-card-info { border-left: 5px solid #1976d2; background-color: #bbdefb; }
    </style>
</head>
<body>

    <div class="kds-header text-center">
        <div class="container">
            <h1 class="display-6 fw-bold">ğŸš€ Market Zinciri Karar Destek Sistemi</h1>
            <p class="mb-0 opacity-75">Stratejik Planlama & Gelecek Tahmini (AI Powered)</p>
        </div>
    </div>

    <div class="container">
        
        <div class="row" id="alertSection">
            <div class="col-12 text-center text-muted py-3">Sistem verileri analiz ediyor...</div>
        </div>

        <div class="row mt-2">
            <div class="col-md-12">
                <div class="card p-4 border-primary" style="border-top: 5px solid #1565C0;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-primary"><i class="bi bi-graph-up-arrow"></i> ğŸ“ˆ Gelecek 6 Ay Ciro Projeksiyonu</h4>
                            <p class="text-muted small mb-0">Lineer Regresyon AlgoritmasÄ± ile hesaplanan tahmini bÃ¼yÃ¼me trendi.</p>
                        </div>
                        <span class="badge bg-primary fs-6">AI Forecast Modu</span>
                    </div>
                    <div style="height: 350px; margin-top: 15px;">
                        <canvas id="tahminChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card p-3">
                    <h5 class="card-title text-secondary">ğŸ“Š Åube BazlÄ± Net KÃ¢r/Zarar Analizi</h5>
                    <div style="height: 250px;">
                        <canvas id="karZararChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3">
                    <h5 class="card-title text-secondary">âš¡ Enerji AltyapÄ± Durumu</h5>
                    <div style="height: 250px; display: flex; justify-content: center;">
                        <canvas id="enerjiChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4 mb-5">
            <div class="col-md-12">
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">ğŸ“‹ Stratejik Karar Tablosu</h4>
                        <button class="btn btn-outline-primary btn-sm" onclick="verileriGetir()">ğŸ”„ Verileri GÃ¼ncelle</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>MaÄŸaza AdÄ±</th>
                                    <th>BÃ¶lge</th>
                                    <th>Toplam Ciro</th>
                                    <th>Giderler (Kira+MaaÅŸ)</th>
                                    <th>Net Durum</th>
                                    <th>KDS Karar Ã–nerisi</th>
                                </tr>
                            </thead>
                            <tbody id="finansTablosu">
                                <tr><td colspan="6" class="text-center">Veriler YÃ¼kleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            verileriGetir();
        });

        // 1. ANA VERÄ° Ã‡EKME FONKSÄ°YONU
        async function verileriGetir() {
            try {
                // Paralel olarak tÃ¼m API'leri Ã§aÄŸÄ±r (Daha hÄ±zlÄ± aÃ§Ä±lÄ±r)
                const [resFinans, resRekabet, resEnerji, resTahmin] = await Promise.all([
                    fetch('http://localhost:3000/api/kds/finans'),
                    fetch('http://localhost:3000/api/kds/rekabet'),
                    fetch('http://localhost:3000/api/kds/enerji'),
                    fetch('http://localhost:3000/api/kds/tahmin')
                ]);

                const dataFinans = await resFinans.json();
                const dataRekabet = await resRekabet.json();
                const dataEnerji = await resEnerji.json();
                const dataTahmin = await resTahmin.json();

                // Ekrana basma fonksiyonlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±r
                uyarilariGoster(dataFinans, dataRekabet, dataEnerji);
                tahminGrafiginiCiz(dataTahmin);
                grafikleriCiz(dataFinans, dataEnerji);
                tabloyuDoldur(dataFinans);

            } catch (error) {
                console.error("Hata:", error);
                document.getElementById('alertSection').innerHTML = `
                    <div class="col-12"><div class="alert alert-danger text-center">
                        âŒ <strong>Sunucu HatasÄ±:</strong> Node.js backend Ã§alÄ±ÅŸmÄ±yor olabilir. LÃ¼tfen 'node server.js' komutunu Ã§alÄ±ÅŸtÄ±rÄ±n.
                    </div></div>`;
            }
        }

        // 2. TAHMÄ°N GRAFÄ°ÄÄ° (En Ã–nemli KÄ±sÄ±m)
        let tahminChartInstance = null; // Grafik tekrar Ã§izilirse eskisi silinsin diye
        function tahminGrafiginiCiz(data) {
            const ctx = document.getElementById('tahminChart').getContext('2d');
            
            // Veri hazÄ±rlÄ±ÄŸÄ±
            const gecmisEtiketler = data.gecmis.map(d => d.ay);
            const gelecekEtiketler = data.gelecek.map(d => d.ay);
            const tumEtiketler = [...gecmisEtiketler, ...gelecekEtiketler];

            const gecmisData = data.gecmis.map(d => d.ciro);
            
            // Gelecek Ã§izgisi geÃ§miÅŸin bittiÄŸi yerden baÅŸlasÄ±n (Kopukluk olmasÄ±n)
            const boslukluGelecekData = new Array(gecmisData.length - 1).fill(null);
            boslukluGelecekData.push(gecmisData[gecmisData.length - 1]); // BaÄŸlantÄ± noktasÄ±
            data.gelecek.forEach(d => boslukluGelecekData.push(d.ciro));

            if(tahminChartInstance) tahminChartInstance.destroy();

            tahminChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: tumEtiketler,
                    datasets: [
                        {
                            label: 'GerÃ§ekleÅŸen Ciro',
                            data: gecmisData,
                            borderColor: '#2e7d32', // YeÅŸil
                            backgroundColor: 'rgba(46, 125, 50, 0.1)',
                            fill: true,
                            tension: 0.3,
                            borderWidth: 3
                        },
                        {
                            label: 'AI Tahmini (Forecasting)',
                            data: boslukluGelecekData,
                            borderColor: '#d32f2f', // KÄ±rmÄ±zÄ±
                            borderDash: [10, 5], // Kesik Ã‡izgi
                            pointStyle: 'triangle',
                            pointRadius: 6,
                            fill: false,
                            tension: 0.3,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        tooltip: { callbacks: { label: (c) => formatMoney(c.raw) } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (val) => val / 1000 + 'k TL' } }
                    }
                }
            });
        }

        // 3. UYARILARI GÃ–STERME
        function uyarilariGoster(finans, rekabet, enerji) {
            const area = document.getElementById('alertSection');
            area.innerHTML = ''; 

            // Finans UyarÄ±sÄ±
            const zarar = finans.filter(d => d.NetDurum < 0);
            if (zarar.length > 0) {
                area.innerHTML += `
                <div class="col-md-4">
                    <div class="card alert-card-danger p-3 h-100">
                        <h5 class="text-danger">ğŸš¨ FÄ°NANSAL ALARM</h5>
                        <p class="mb-1"><strong>${zarar.length} Åube</strong> zarar bÃ¶lgesinde.</p>
                        <p class="small text-muted mb-0">Ã–rn: ${zarar[0].MagazaAdi} acil incelenmeli.</p>
                    </div>
                </div>`;
            }

            // Rekabet UyarÄ±sÄ±
            if (rekabet.length > 0) {
                area.innerHTML += `
                <div class="col-md-4">
                    <div class="card alert-card-warning p-3 h-100">
                        <h5 class="text-danger" style="color:#d32f2f;">âš”ï¸ RAKÄ°P TEHDÄ°DÄ°</h5>
                        <p class="mb-1"><strong>${rekabet[0].MagazaAdi}</strong> yakÄ±nÄ±na <strong>${rekabet[0].RakipAdi}</strong> aÃ§Ä±lÄ±yor!</p>
                        <p class="small text-muted mb-0 fw-bold">${rekabet[0].Stratejik_Oneri}</p>
                    </div>
                </div>`;
            }

            // Enerji UyarÄ±sÄ±
            const eski = enerji.filter(d => d.EnerjiSinifi === 'F');
            if (eski.length > 0) {
                area.innerHTML += `
                <div class="col-md-4">
                    <div class="card alert-card-info p-3 h-100">
                        <h5 class="text-primary">âš¡ ENERJÄ° VERÄ°MLÄ°LÄ°ÄÄ°</h5>
                        <p class="mb-1"><strong>${eski.length} adet F SÄ±nÄ±fÄ±</strong> eski cihaz tespit edildi.</p>
                        <p class="small text-muted mb-0">DeÄŸiÅŸim yatÄ±rÄ±mÄ±nÄ±n geri dÃ¶nÃ¼ÅŸÃ¼: ~14 Ay</p>
                    </div>
                </div>`;
            }
        }

        // 4. DÄ°ÄER GRAFÄ°KLER
        let barChart = null;
        let pieChart = null;

        function grafikleriCiz(finans, enerji) {
            // Bar Chart (Ä°lk 15 Åube)
            const top15 = finans.slice(0, 15);
            const ctx1 = document.getElementById('karZararChart').getContext('2d');
            const colors = top15.map(s => s.NetDurum < 0 ? '#d32f2f' : '#2e7d32');
            
            if(barChart) barChart.destroy();
            barChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: top15.map(s => s.MagazaAdi.replace('Åubesi', '')),
                    datasets: [{
                        label: 'Net KÃ¢r/Zarar',
                        data: top15.map(s => s.NetDurum),
                        backgroundColor: colors,
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Pie Chart
            const ctx2 = document.getElementById('enerjiChart').getContext('2d');
            const aSinifi = enerji.filter(e => e.EnerjiSinifi.includes('A')).length;
            const diger = enerji.length - aSinifi;

            if(pieChart) pieChart.destroy();
            pieChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Verimli (A/A++)', 'Verimsiz (C/F)'],
                    datasets: [{
                        data: [aSinifi, diger],
                        backgroundColor: ['#4caf50', '#ef5350'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // 5. TABLO DOLDURMA
        function tabloyuDoldur(data) {
            const tbody = document.getElementById('finansTablosu');
            tbody.innerHTML = '';
            
            // Ã–nce zarar edenleri en Ã¼ste al
            data.sort((a, b) => a.NetDurum - b.NetDurum);

            data.forEach(sube => {
                let rowClass = '';
                if (sube.NetDurum < 0) rowClass = 'status-red';
                else if (sube.NetDurum > 80000) rowClass = 'status-green';

                const row = `
                    <tr class="${rowClass}">
                        <td><strong>${sube.MagazaAdi}</strong></td>
                        <td>${sube.Bolge}</td>
                        <td>${formatMoney(sube.Ciro)}</td>
                        <td class="text-danger">-${formatMoney(sube.ToplamGider)}</td>
                        <td class="fw-bold">${formatMoney(sube.NetDurum)}</td>
                        <td>${sube.KDS_Onerisi}</td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(amount);
        }
    </script>
</body>
</html>